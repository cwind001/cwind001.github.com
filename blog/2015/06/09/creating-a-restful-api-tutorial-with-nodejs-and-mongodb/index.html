
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>MEAN全栈开发：使用NodeJS和MongoDB创建REST服务 - 辰风君的笔记本</title>
  <meta name="author" content="辰风君">

  
  <meta name="description" content="本教程介绍如何使用Node.js (Express.js) 和MongoDB (mongoose) 创建REST服务。你可以参考本教程创建一个独立的后台服务，也可以回顾之前的AngularJS或是BackboneJS教程来构建一个javascript客户端，来与我们将要构建的后台集成。 第二部分 &hellip;">
  <meta name="keywords" content="MEAN, 全栈开发, Nodejs, Angularjs, Express, MongoDB">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cwind001.github.io/blog/2015/06/09/creating-a-restful-api-tutorial-with-nodejs-and-mongodb/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="辰风君的笔记本" type="application/atom+xml">
  <link href='http://fonts.useso.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.useso.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.useso.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.useso.com/css?family=Special+Elite:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.useso.com/css?family=Marko+One:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.useso.com/css?family=Lato:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">辰风君的笔记本</a></h1>
  
    <h2>Cwind’s Technical Notes</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://www.bing.com" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cwind001.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">文章存档</a></li>
  <li><a href="/blog/translation">外文翻译</a></li>
  <li><a href="/about">关于我</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">MEAN全栈开发：使用NodeJS和MongoDB创建REST服务</h1>
      
    
    
      <p class="meta">
        



<time class='entry-date' datetime='2015-06-09T21:30:19+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:30 pm</span></time>
		
        
          | <a href="#comments">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>本教程介绍如何使用Node.js (Express.js) 和MongoDB (mongoose) 创建REST服务。你可以参考本教程创建一个独立的后台服务，也可以回顾之前的<a href="http://gocwind.com/blog/2015/06/05/angularjs-tutorial-for-beginners/">AngularJS</a>或是<a href="http://adrianmejia.com/blog/2012/09/11/backbone-dot-js-for-absolute-beginners-getting-started">BackboneJS</a>教程来构建一个javascript客户端，来与我们将要构建的后台集成。  </p>

<p><img class="left" src="http://dl.iteye.com/upload/picture/pic/133663/abf21050-a55a-347e-9e0f-501586af10c7.png" /><br />
<img src="http://dl.iteye.com/upload/picture/pic/133661/636d3c41-5c03-33a4-af9f-a539fc997fcd.png" /><br />
<!--more-->  </p>

<h1 id="nodejsmongodbrest">第二部分 使用NodeJS和MongoDB创建REST服务</h1>

<h2 id="restful-api">RESTful API是什么</h2>

<p>REST指表述性状态转移。它是允许以统一的接口进行客户端-服务器通信的架构。REST是“无状态”、“可缓存”以及“幂等”的。幂等意味着多次调用与单次请求的结果相同。  </p>

<p>HTTP RESTful API 由以下要素组成：  </p>

<ul>
  <li>HTTP方法，如GET，PUT，DELETE，PATCH，POST，……  </li>
  <li>基本URL，如 http://gocwind.com/   </li>
  <li>URL路径，如 /blog/2014/10/01/creating-a-restful-api-tutorial-with-nodejs-and-mongodb/  </li>
  <li>媒介类型，如html，JSON，XML，Microformats，Atom，Images……  </li>
</ul>

<p>下表是我们将要实现的API摘要：  </p>
<table>
<tbody>
<tr><td><strong>Resource(URI) </strong></td><td><strong>POST(创建) </strong></td><td><strong>GET(读取) </strong></td><td><strong>PUT(更新 )</strong></td><td><strong>DELETE(删除) </strong></td></tr>
<tr><td>/todos</td><td>创建新的任务 </td><td>列出所有任务  </td><td>N/A（更新全部）</td><td>N/A（删除全部） </td></tr>
<tr><td>/todos/1</td><td>错误 </td><td>显示ID为1的任务  </td><td>更新ID为1的任务  </td><td>删除ID为1的任务  </td></tr>
</tbody>
</table>
<p><br /></p>

<p><strong>注意</strong>：我们采用JSON格式。批量更新和批量删除并不安全，所以我们将不实现这两个接口。POST，GET，PUT，DELETE方法分别对应创建(CREATE)，查询(READ)，更新(UPDATE)，删除(DELETE)操作，即CRUD。  </p>

<h2 id="section">搭建开发环境</h2>

<p>MEAN技术栈的两个主要组件是NodeJS以及MongoDB。<br />
<img src="http://dl.iteye.com/upload/picture/pic/133677/a1b8cfdb-27cc-3d4f-8494-7cde0cb41ff9.png" />  </p>

<p>注意：如果你已经安装了NodeJS，MongoDB(Mongoose)，ExpressJS并且分别对它们已经有所了解，你可以跳过下面一节。如果你想要回顾或了解以上的每个成员，请继续阅读。  </p>

<h2 id="nodejs">NodeJS</h2>
<p>简言之，NodeJS是运行在服务器上，浏览器之外的JavaScript。    </p>

<p>安装NodeJS，可以访问<a href="http://nodejs.org/">NodeJS官方网站</a>。如果你使用Mac和<a href="http://brew.sh/">brew</a>你可以执行brew install nodejs，如果你使用ubuntu可以利用<a href="https://github.com/creationix/nvm">nvm</a>来安装它。  </p>

<p>检查node版本和npm版本：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
</pre></td>
  <td class="code"><pre>  
node -v
<span class="error">#</span> =&gt; v0<span class="float">.12</span><span class="float">.4</span>

npm -v
<span class="error">#</span> =&gt; <span class="float">2.10</span><span class="float">.1</span>
</pre></td>
</tr></table>
 </figure></notextile></div>

<h2 id="expressjs">ExpressJS</h2>

<p>ExpressJS是运行在NodeJS上的Web应用框架。它可以用于构建Web应用或API服务（后文详述）。  </p>

<p>利用npm安装它：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre> 
npm install -g express
</pre></td>
</tr></table>
 </figure></notextile></div>

<p>请注意<code>-g</code>选项。它将会把<code>express</code>安装供全局使用，并加入<code>PATH</code>环境变量，因此你可以在任何地方运行它。  </p>

<p>检查版本：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre>   
express --version
<span class="error">#</span> =&gt; <span class="float">4.12</span><span class="float">.4</span>
</pre></td>
</tr></table>
 </figure></notextile></div>

<h2 id="mongodb">MongoDB</h2>

<p>MongoDB是一个面向文档的NoSQL数据库（可用于处理大数据）。它将数据以JSON格式存储，允许执行类似SQL的查询。
你可以参照<a href="http://docs.mongodb.org/manual/installation/">这篇文档</a>来安装它。如果你使用Mac和brew，就可以简单执行：<code>brew install mongodb &amp;&amp; mongod</code>。在ubuntu下则是 <code>sudo apt-get -y install mongodb</code>。   </p>

<p>检查版本：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
</pre></td>
  <td class="code"><pre>  
<span class="error">#</span> Mac
mongod --version
<span class="error">#</span> =&gt; db version v2<span class="float">.6</span><span class="float">.4</span>
<span class="error">#</span> =&gt; <span class="integer">2014</span>-<span class="integer">10</span>-<span class="octal">01</span>T19:<span class="octal">07</span>:<span class="float">26.649</span>-<span class="octal">0400</span> git version: nogitversion

<span class="error">#</span> Ubuntu
mongod --version
<span class="error">#</span> =&gt; db version v2<span class="float">.0</span><span class="float">.4</span>, pdfile version <span class="float">4.5</span>
<span class="error">#</span> =&gt; Wed Oct  <span class="integer">1</span> <span class="integer">23</span>:<span class="octal">06</span>:<span class="integer">54</span> git version: nogitversion
</pre></td>
</tr></table>
 </figure></notextile></div>

<h2 id="mean">理解MEAN技术栈</h2>

<p>经过以上几步你已经准备好了用于完成本教程的所有事情。简单地说，我们将会构建RESTful API，使得用户可以执行CRUD（创建-读取-更新-删除）操作，来处理数据库中的Todo任务。  </p>

<h3 id="mongoose-crud">Mongoose CRUD</h3>

<p>CRUD = Create-Read-Update-Delete (创建-读取-更新-删除)  </p>

<p>我们可以在控制台里使用Mongoose。在<code>todoAPIjs</code>目录，键入<code>node</code>来进入node CLI，然后：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
<a href="#n13" name="n13">13</a>
</pre></td>
  <td class="code"><pre> 
<span class="comment">/* prompt&gt; */</span> <span class="keyword">var</span> mongoose = require(<span class="string"><span class="delimiter">'</span><span class="content">mongoose</span><span class="delimiter">'</span></span>);

<span class="comment">/* prompt&gt; */</span> mongoose.connect(<span class="string"><span class="delimiter">'</span><span class="content">mongodb://localhost/test3</span><span class="delimiter">'</span></span>);

<span class="comment">/* prompt&gt; */</span> <span class="keyword">var</span> TodoSchema = <span class="keyword">new</span> mongoose.Schema({
  <span class="key">name</span>: String,
  <span class="key">completed</span>: Boolean,
  <span class="key">note</span>: String,
  <span class="key">updated_at</span>: { <span class="key">type</span>: Date, <span class="keyword">default</span>: Date.now },
});

<span class="comment">/* prompt&gt; */</span> <span class="keyword">var</span> Todo = mongoose.model(<span class="string"><span class="delimiter">'</span><span class="content">Todo</span><span class="delimiter">'</span></span>, TodoSchema);
</pre></td>
</tr></table>
 </figure></notextile></div>

<p><strong>Mongoose 创建</strong>  </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
</pre></td>
  <td class="code"><pre>  
<span class="comment">/* prompt&gt; */</span> <span class="keyword">var</span> todo = <span class="keyword">new</span> Todo({<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Master NodeJS</span><span class="delimiter">'</span></span>, <span class="key">completed</span>: <span class="predefined-constant">false</span>, <span class="key">note</span>: <span class="string"><span class="delimiter">'</span><span class="content">Getting 
there...</span><span class="delimiter">'</span></span>});

<span class="comment">/* prompt&gt; */</span> todo.save(<span class="keyword">function</span>(err){
    <span class="keyword">if</span>(err)
        console.log(err);
    <span class="keyword">else</span>
        console.log(todo);
});
</pre></td>
</tr></table>
 </figure></notextile></div>

<p>你可以创建对象，并利用<code>create</code>来进行保存：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
</pre></td>
  <td class="code"><pre>  
<span class="comment">/* prompt&gt; */</span> Todo.create({<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Master Javscript</span><span class="delimiter">'</span></span>, <span class="key">completed</span>: <span class="predefined-constant">true</span>, <span class="key">note</span>: <span class="string"><span class="delimiter">'</span><span class="content">Getting better 
everyday</span><span class="delimiter">'</span></span>}, <span class="keyword">function</span>(err, todo){
    <span class="keyword">if</span>(err) console.log(err);
    <span class="keyword">else</span> console.log(todo);
});
</pre></td>
</tr></table>
 </figure></notextile></div>

<p><strong>Mongoose 读取与查询</strong>  </p>

<p>读取/查询数据有下列多种方式：  </p>

<ul>
  <li>Model.find(conditions, [fields], [options], [callback])   </li>
  <li>Model.findById(id, [fields], [options], [callback])   </li>
  <li>Model.findOne(conditions, [fields], [options], [callback])</li>
</ul>

<p>一些例子：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>Find all </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
</pre></td>
  <td class="code"><pre>  
<span class="comment">/* prompt&gt; */</span> Todo.find(<span class="keyword">function</span> (err, todos) {
  <span class="keyword">if</span> (err) <span class="keyword">return</span> console.error(err);
  console.log(todos)
});
</pre></td>
</tr></table>
 </figure></notextile></div>

<p>你也可以加入查询条件：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>Find with queries </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
</pre></td>
  <td class="code"><pre>  
<span class="comment">/* prompt&gt; */</span> <span class="keyword">var</span> <span class="function">callback</span> = <span class="keyword">function</span> (err, data) {
  <span class="keyword">if</span> (err) <span class="keyword">return</span> console.error(err);
  <span class="keyword">else</span> console.log(data);
}

<span class="comment">// Get all completed tasks</span>
<span class="comment">/* prompt&gt; */</span> Todo.find({<span class="key">completed</span>: <span class="predefined-constant">true</span> }, callback);

<span class="comment">// Get all tasks ending with `JS`</span>
<span class="comment">/* prompt&gt; */</span> Todo.find({<span class="key">name</span>: <span class="regexp"><span class="delimiter">/</span><span class="content">JS$</span><span class="delimiter">/</span></span> }, callback);
</pre></td>
</tr></table>
 </figure></notextile></div>

<p>当然，也可以加入多个查询条件，例如：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
</pre></td>
  <td class="code"><pre>  
<span class="comment">/* prompt&gt; */</span> <span class="keyword">var</span> oneYearAgo = <span class="keyword">new</span> Date();
oneYearAgo.setYear(oneYearAgo.getFullYear() - <span class="integer">1</span>);

<span class="comment">// Get all tasks staring with `Master`, completed</span>
<span class="comment">/* prompt&gt; */</span> Todo.find({<span class="key">name</span>: <span class="regexp"><span class="delimiter">/</span><span class="content">^Master</span><span class="delimiter">/</span></span>, <span class="key">completed</span>: <span class="predefined-constant">true</span> }, callback);

<span class="comment">// Get all tasks staring with `Master`, not completed and created from year ago to now...</span>
<span class="comment">/* prompt&gt; */</span> Todo.find({<span class="key">name</span>: <span class="regexp"><span class="delimiter">/</span><span class="content">^Master</span><span class="delimiter">/</span></span>, <span class="key">completed</span>: <span class="predefined-constant">false</span> }).where(<span class="string"><span class="delimiter">'</span><span class="content">updated_at</span><span class="delimiter">'</span></span>).gt(oneYearAgo)
.exec(callback);
</pre></td>
</tr></table>
 </figure></notextile></div>

<p><strong>Mongoose 更新</strong>  </p>

<p>每个模型都有一个<code>update</code>方法，可以接受多条数据的更新操作（用于批量更新，并不返回数据数组）。同时<code>findOneAndUpdate</code>方法可以用于更新单独一条数据并将该条数据返回。  </p>

<ul>
  <li>Model.update(conditions, update, [options], [callback])   </li>
  <li>Model.findByIdAndUpdate(id, [update], [options], [callback])   </li>
  <li>Model.findOneAndUpdate([conditions], [update], [options], [callback])  </li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>Todo.update and Todo.findOneAndUpdate </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
<a href="#n13" name="n13">13</a>
</pre></td>
  <td class="code"><pre>  
<span class="comment">// Model.update(conditions, update, [options], [callback])</span>
<span class="comment">// update `multi`ple tasks from complete false to true</span>

<span class="comment">/* prompt&gt; */</span> Todo.update({ <span class="key">completed</span>: <span class="predefined-constant">false</span> }, { <span class="key">completed</span>: <span class="predefined-constant">true</span> }, { <span class="key">multi</span>: <span class="predefined-constant">true</span> }, 
<span class="keyword">function</span> (err, numberAffected, raw) {
  <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);
  console.log(<span class="string"><span class="delimiter">'</span><span class="content">The number of updated documents was %d</span><span class="delimiter">'</span></span>, numberAffected);
  console.log(<span class="string"><span class="delimiter">'</span><span class="content">The raw response from Mongo was </span><span class="delimiter">'</span></span>, raw);
});

<span class="comment">//Model.findOneAndUpdate([conditions], [update], [options], [callback])</span>
<span class="comment">/* prompt&gt; */</span> Todo.findOneAndUpdate({<span class="key">name</span>: <span class="regexp"><span class="delimiter">/</span><span class="content">JS$</span><span class="delimiter">/</span></span> }, {<span class="key">completed</span>: <span class="predefined-constant">false</span>}, callback);
</pre></td>
</tr></table>
 </figure></notextile></div>

<p><strong>Mongoose 删除</strong>  </p>

<p>mongoose的<code>update</code>与<code>remove</code> API非常相似，唯一的区别是并没有任何元素被返回。  </p>

<ul>
  <li>Model.remove(conditions, [callback])   </li>
  <li>Model.findByIdAndRemove(id, [options], [callback])   </li>
  <li>Model.findOneAndRemove(conditions, [options], [callback])  </li>
</ul>

<h3 id="expressjs-1">ExpressJS与中间件</h3>

<p>ExpressJS是一个完备的Web框架解决方案。它包括HTML模板解决方案（jade, ejs, handlebars, hogan.js）与CSS预编译器（less, stylus, compass）。在中间件层它能够处理：cookies, sessions, caching, CSRF, 压缩以及许多其他的功能。  </p>

<p><strong>中间件</strong>是一组用于处理每个发往服务器的请求的软件栈。你可以使用任意数量的中间件，以串行方式一个接一个地处理请求。其中的一些可能用于改变请求输入，打印日志输出，添加数据并将其传递到处理链中的下一个中间件。  </p>

<p>中间件通过<code>app.use</code>被加载到ExpressJS栈，从而可以被任何方法或app.动词（如app.get, app.delete, app.post, app.update, …）所使用。  </p>

<p><img src="http://dl.iteye.com/upload/picture/pic/133679/eb6d578c-b8fe-33ab-aad1-20728b95ffe3.png" /></p>

<p>假设我们想要打印每个请求的来源客户端的IP：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>Log the client IP on every request </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
</pre></td>
  <td class="code"><pre>  
app.use(<span class="keyword">function</span> (req, res, next) {
  <span class="keyword">var</span> ip = req.headers[<span class="string"><span class="delimiter">'</span><span class="content">x-forwarded-for</span><span class="delimiter">'</span></span>] || req.connection.remoteAddress;
  console.log(<span class="string"><span class="delimiter">'</span><span class="content">Client IP:</span><span class="delimiter">'</span></span>, ip);
  next();
});
</pre></td>
</tr></table>
 </figure></notextile></div>

<p>你也可以指定路径，使得你的中间件在该路径生效： </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>Middleware mounted on “/todos/:id” and log the request method </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
</pre></td>
  <td class="code"><pre>  
app.use(<span class="string"><span class="delimiter">'</span><span class="content">/todos/:id</span><span class="delimiter">'</span></span>, <span class="keyword">function</span> (req, res, next) {
  console.log(<span class="string"><span class="delimiter">'</span><span class="content">Request Type:</span><span class="delimiter">'</span></span>, req.method);
  next();
});
</pre></td>
</tr></table>
 </figure></notextile></div>

<p>最终，你可以使用app.get来捕捉相匹配路由的GET请求，在中间件链末端通过<code>response.send</code>来为该请求产生一个响应。让我们使用mongoose读取与查询一节中的函数来返回一条与参数id相匹配的用户数据。  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>Middleware mounted on “/todos/:id” and returns </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
</pre></td>
  <td class="code"><pre>  
app.get(<span class="string"><span class="delimiter">'</span><span class="content">/todos/:id</span><span class="delimiter">'</span></span>, <span class="keyword">function</span> (req, res, next) {
  Todo.findById(req.params.id, <span class="keyword">function</span>(err, todo){
    <span class="keyword">if</span>(err) res.send(err);
    res.json(todo);
  });
});
</pre></td>
</tr></table>
 </figure></notextile></div>

<p>请注意之前所有的中间件都调用了<code>next()</code>，除了这最后一个，因为它将把包含指定<code>todo</code>数据的响应（以JSON格式）发送给客户端。  </p>

<p>除了路由之外，你不必自己去开发各种功能的中间件。因为ExpressJS已经包含了许多常用的中间件。  </p>

<h3 id="express-40-">Express 4.0 默认中间件</h3>

<ul>
  <li><a href="https://github.com/expressjs/morgan">morgan</a>: 日志处理  </li>
  <li><a href="https://github.com/expressjs/body-parser">body-parser</a>: 解析请求体，从而可以访问请求体<code>req.body</code>中的参数。例如：<code>req.body.name</code>。  </li>
  <li><a href="https://github.com/expressjs/cookie-parser">cookie-parser</a>: 解析cookies，从而可以访问cookies中的参数。例如：<code>req.cookies.name</code>。  </li>
  <li><a href="https://github.com/expressjs/serve-favicon">serve-favicon</a>: 顾名思义，为路由/favicon.ico提供图标。它应该在其他任何路由/中间件之前被调用，从而避免不必要的解析。  </li>
</ul>

<h3 id="express">其他Express中间件</h3>
<p>下列中间件并非内置，但了解一下很有益处。  </p>

<ul>
  <li><a href="https://github.com/expressjs/compression">compression</a>: 压缩所有请求。例：app.use(compression())  </li>
  <li><a href="https://github.com/expressjs/session">session</a>: 创建会话。例：app.use(session({secret: ‘Secr3t’}))  </li>
  <li><a href="https://github.com/expressjs/method-override">method-override</a>: <code>app.use(methodOverride('_method'))</code>，以<code>_method</code>参数值来覆盖方法。例：<code>GET /resource/1?_method=DELETE</code>将会变为<code>DELETE /resource/1</code>  </li>
  <li><a href="https://github.com/expressjs/response-time">response-time</a>: <code>app.use(responseTime())</code>向响应添加响应头<code>X-Response-Time</code>。  </li>
  <li><a href="https://github.com/expressjs/errorhandler">errorhandler</a>: 当错误发生时，通过向客户端发送完整的错误堆栈来辅助开发。<code>app.use(errorhandler())</code>。一个最佳实践是在加载它之前检测环境：<code>process.env.NODE_ENV === 'development'</code>。  </li>
  <li><a href="https://github.com/expressjs/vhost">vhost</a>: 允许你根据请求的<code>hostname</code>不同使用不同的中间件栈。例：<code>app.use(vhost('*.user.local', userapp))</code>以及<code>app.use(vhost('assets-*.example.com', staticapp))</code>，其中<code>userapp</code>与<code>staticapp</code>是有不同中间件栈的不同express实例。  </li>
  <li><a href="https://github.com/expressjs/csurf">csrurf</a>: 使用<code>session</code>或<code>cookie-parser</code>在响应中添加token，起到防止跨站请求伪造（Cross-site request forgery, CSRF）的作用。例：<code>app.use(csrf())</code>。  </li>
  <li><a href="https://github.com/expressjs/timeout">timeout</a>: 当程序执行时间超过预设值时终止程序。例：<code>app.use(timeout('5s'));</code>。你需要自定义一个中间件检查每一个请求<code>if(!req.timeout) next();</code>。  </li>
</ul>

<h2 id="api-postmancurl">API 客户端（浏览器，Postman和curl）</h2>
<p>我知道你还没有创建路由，我们在下一节中将会创建。通过你创建的API，有三种方式来查询、改动或删除数据。  </p>

<h3 id="curl">Curl</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>Create tasks </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
</pre></td>
  <td class="code"><pre> 
<span class="error">#</span> Create task
curl -XPOST http:<span class="comment">//localhost:3000/todos -d 'name=Master%20Routes&amp;completed=false&amp;note=soon...'</span>

<span class="error">#</span> List tasks
curl -XGET http:<span class="comment">//localhost:3000/todos</span>
</pre></td>
</tr></table>
 </figure></notextile></div>

<h3 id="postman">浏览器和Postman</h3>
<p>当你打开浏览器并在地址栏输入<code>localhost:3000/todos</code>你将会看到所有的任务（当你实现了API之后）。然而，默认情况下你并不能POST命令。为了后面的测试，我们可以使用一个名为Postman[link]的Chrome插件。它使你能够很容易地使用所有的HTTP命令，如果需要添加参数时，选中<code>x-www-form-urlencoded</code>。（译者注：使用RestClient for Firefox一样很方便）。  </p>

<p><img src="http://dl.iteye.com/upload/picture/pic/133681/84a293ae-e910-37af-abae-194e60294aed.png" /></p>

<h3 id="section-1">网站和移动应用</h3>
<p>这很有可能是最主要的API调用者。你可以使用jQuery<code>$ajax</code>方便地与RESTful API交互，或者使用它的包装器–BackboneJS的Collections/models， AngularJS的<code>$http</code>或<code>$resource</code>，或许许多多其他的库/框架以及移动客户端。  </p>

<p>最后，我们来阐释如何使用AngularJS与API交互。  </p>

<p><img src="http://dl.iteye.com/upload/picture/pic/133683/1737b0c6-2c33-3ed9-89aa-9bc385dd89cd.png" /><br />
（图片来自CodeSchool）  </p>

<p>整合MEAN技术栈</p>

<h2 id="expressjs-2">引导ExpressJS</h2>

<p>花了较大篇幅来了解Node CLI，MongoDB，Mongoose，工具以及中间件之后，让我们回到我们的express应用todoApp。现在我们创建路由并最终实现我们的RESTful API。<br />
通过<code>express -e todoApp</code>创建应用。安装所有依赖<code>cd todoApp &amp;&amp; npm install</code>。运行该应用：<code>DEBUG=todoApp ./bin/www</code>；  </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
<a href="#n13" name="n13">13</a>
<a href="#n14" name="n14">14</a>
<a href="#n15" name="n15">15</a>
<a href="#n16" name="n16">16</a>
<a href="#n17" name="n17">17</a>
<a href="#n18" name="n18">18</a>
<a href="#n19" name="n19">19</a>
<strong><a href="#n20" name="n20">20</a></strong>
<a href="#n21" name="n21">21</a>
<a href="#n22" name="n22">22</a>
<a href="#n23" name="n23">23</a>
<a href="#n24" name="n24">24</a>
<a href="#n25" name="n25">25</a>
<a href="#n26" name="n26">26</a>
<a href="#n27" name="n27">27</a>
</pre></td>
  <td class="code"><pre> 
express -e todoApp
<span class="error">#</span> =&gt;   create : todoApp                  <span class="error">#</span> app directory  
<span class="error">#</span> =&gt;   create : todoApp/<span class="reserved">package</span>.json     <span class="error">#</span> file containing all the dependencies
<span class="error">#</span> =&gt;   create : todoApp/app.js           <span class="error">#</span> Entry point of the application: defines middleware, 
initialize database connections, routes and more.
<span class="error">#</span> =&gt;   create : todoApp/<span class="reserved">public</span>           <span class="error">#</span> all files contained here are accessible through to 
<span class="reserved">public</span> (browser or API calls).
<span class="error">#</span> =&gt;   create : todoApp/<span class="reserved">public</span>/javascripts
<span class="error">#</span> =&gt;   create : todoApp/<span class="reserved">public</span>/images
<span class="error">#</span> =&gt;   create : todoApp/<span class="reserved">public</span>/stylesheets
<span class="error">#</span> =&gt;   create : todoApp/<span class="reserved">public</span>/stylesheets/style.css
<span class="error">#</span> =&gt;   create : todoApp/routes           <span class="error">#</span> containes all the routes files
<span class="error">#</span> =&gt;   create : todoApp/routes/index.js
<span class="error">#</span> =&gt;   create : todoApp/routes/users.js
<span class="error">#</span> =&gt;   create : todoApp/views            <span class="error">#</span> contains all the HTML templates
<span class="error">#</span> =&gt;   create : todoApp/views/index.ejs
<span class="error">#</span> =&gt;   create : todoApp/views/error.ejs
<span class="error">#</span> =&gt;   create : todoApp/bin              <span class="error">#</span> contains executable files
<span class="error">#</span> =&gt;   create : todoApp/bin/www          <span class="error">#</span> bootstrap the app: loads app.js, and set the port 
<span class="keyword">for</span> the webserver.
<span class="error">#</span> =&gt;
<span class="error">#</span> =&gt;   install dependencies:
<span class="error">#</span> =&gt;     <span class="predefined">$</span> cd todoApp &amp;&amp; npm install
<span class="error">#</span> =&gt;
<span class="error">#</span> =&gt;   run the app:
<span class="error">#</span> =&gt;     <span class="predefined">$</span> DEBUG=todoApp .<span class="regexp"><span class="delimiter">/</span><span class="content">bin</span><span class="delimiter">/</span></span>www
</pre></td>
</tr></table>
 </figure></notextile></div>

<h3 id="expressjsmongodb">将ExpressJS与MongoDB连接</h3>
<p>在上一节中你已经安装好了MongoDB，键入以下命令来启动它：<br />
<code>mongod</code><br />
为NodeJS安装名为mongoose的MongoDB驱动：<br />
<code>npm install mongoose --save</code>  </p>

<p>注意<code>--save</code>参数，这将会把它加到<code>todoApp/package.json</code>里。<br />
接下来，你需要在<code>todoApp/app.js</code>里引入mongoose。  </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
</pre></td>
  <td class="code"><pre> 
<span class="keyword">var</span> mongoose = require(<span class="string"><span class="delimiter">'</span><span class="content">mongoose</span><span class="delimiter">'</span></span>);
mongoose.connect(<span class="string"><span class="delimiter">'</span><span class="content">mongodb://localhost/todoApp</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(err) {
    <span class="keyword">if</span>(err) {
        console.log(<span class="string"><span class="delimiter">'</span><span class="content">connection error</span><span class="delimiter">'</span></span>, err);
    } <span class="keyword">else</span> {
        console.log(<span class="string"><span class="delimiter">'</span><span class="content">connection successful</span><span class="delimiter">'</span></span>);
    }
});
</pre></td>
</tr></table>
 </figure></notextile></div>

<p>现在，你可以运行<code>npm start</code>或者<code>./bin/www</code>，你将会注意到下面的信息：<code>connection successful</code>。看到了吗？很好！  </p>

<p>你可以查看<a href="https://github.com/amejiarosario/todoAPIjs">完整的代码</a>， 或者截止目前我们所做的<a href="https://github.com/amejiarosario/todoAPIjs/commit/d3be6a287e8aff39ab862971da4f050d04e552a1">改动</a>。  </p>

<h3 id="mongoosetodo">使用Mongoose创建Todo模型</h3>

<p>表演时间到！目前为止，上面所做的工作都是搭建环境和准备工作。现在我们开始专注于实现API。<br />
创建<code>models</code>目录以及<code>Todo.js</code>模型：<br />
<code>mkdir models  
touch models/Todo.js</code></p>

<p>编辑models/Todo.js文件：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
</pre></td>
  <td class="code"><pre> 
<span class="keyword">var</span> mongoose = require(<span class="string"><span class="delimiter">'</span><span class="content">mongoose</span><span class="delimiter">'</span></span>);
<span class="keyword">var</span> TodoSchema = <span class="keyword">new</span> mongoose.Schema({
  <span class="key">name</span>: String,
  <span class="key">completed</span>: Boolean,
  <span class="key">note</span>: String,
  <span class="key">updated_at</span>: { <span class="key">type</span>: Date, <span class="keyword">default</span>: Date.now },
});
module.exports = mongoose.model(<span class="string"><span class="delimiter">'</span><span class="content">Todo</span><span class="delimiter">'</span></span>, TodoSchema);
</pre></td>
</tr></table>
 </figure></notextile></div>

<p><a href="https://github.com/amejiarosario/todoAPIjs/commit/afc908027339b22f10de3b77518ac0728668d470">变更</a>  </p>

<p>这里发生了什么？MongoDB难道不是无模式的吗？没错，它确实无模式并且很灵活，然而，很多情况下我们会想要使我们的数据保持一个一致的结构，从而方便验证，也方便我们的API/WebApp实际应用。Mongoose帮我们做了这些事情。  </p>

<p>我们可以使用下面的类型：  </p>

<ul>
  <li>String  </li>
  <li>Boolean  </li>
  <li>Date  </li>
  <li>Array   </li>
  <li>Number   </li>
  <li>ObjectId   </li>
  <li>Mixed   </li>
  <li>Buffer  </li>
</ul>

<h3 id="expressjs-">ExpressJS 路由</h3>
<p>我们将要实现以下API：  </p>
<table>
<tbody>
<tr><td><strong>Resource(URI) </strong></td><td><strong>POST(创建) </strong></td><td><strong>GET(读取) </strong></td><td><strong>PUT(更新 )</strong></td><td><strong>DELETE(删除) </strong></td></tr>
<tr><td>/todos</td><td>创建新的任务 </td><td>列出所有任务  </td><td>N/A（更新全部）</td><td>N/A（删除全部） </td></tr>
<tr><td>/todos/:id </td><td>错误 </td><td>显示ID为:id的任务  </td><td>更新ID为:id的任务  </td><td>删除ID为:id的任务  </td></tr>
</tbody>
</table>
<p><br /></p>

<p>建立路由：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>Create a new route called `todos.js` in the `routes` folder or rename `users.js` </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre>  
mv routes/users.js routes/todos.js
</pre></td>
</tr></table>
 </figure></notextile></div>

<p>在<code>app.js</code>中，添加新的<code>todos</code>路由，或者替换<code>./routes/users</code>为<code>./routes/todos</code>  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>Adding todos routes </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
</pre></td>
  <td class="code"><pre>
<span class="keyword">var</span> todos = require(<span class="string"><span class="delimiter">'</span><span class="content">./routes/todos</span><span class="delimiter">'</span></span>);
app.use(<span class="string"><span class="delimiter">'</span><span class="content">/todos</span><span class="delimiter">'</span></span>, todos);
</pre></td>
</tr></table>
 </figure></notextile></div>

<p>搞定！现在返回编辑<code>routes/todos.js</code>。 </p>

<p><strong>查询： GET /todos</strong><br />
还记得Mongoose查询API吗？下面的例子显示如何在上下文中使用它：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>routes/todos.js </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
<a href="#n9" name="n9">9</a>
<strong><a href="#n10" name="n10">10</a></strong>
<a href="#n11" name="n11">11</a>
<a href="#n12" name="n12">12</a>
<a href="#n13" name="n13">13</a>
</pre></td>
  <td class="code"><pre>
<span class="keyword">var</span> express = require(<span class="string"><span class="delimiter">'</span><span class="content">express</span><span class="delimiter">'</span></span>);
<span class="keyword">var</span> router = express.Router();
<span class="keyword">var</span> mongoose = require(<span class="string"><span class="delimiter">'</span><span class="content">mongoose</span><span class="delimiter">'</span></span>);
<span class="keyword">var</span> Todo = require(<span class="string"><span class="delimiter">'</span><span class="content">../models/Todo.js</span><span class="delimiter">'</span></span>);
<span class="comment">/* GET /todos listing. */</span>
router.get(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(req, res, next) {
  Todo.find(<span class="keyword">function</span> (err, todos) {
    <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);
    res.json(todos);
  });
});
module.exports = router;
</pre></td>
</tr></table>
 </figure></notextile></div>

<p>收获时间到！数据库里暂时没有任务记录，不过我们至少可以证明它能够正常工作：  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>Testing all together </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
</pre></td>
  <td class="code"><pre>
<span class="error">#</span> Start database
mongod
<span class="error">#</span> Start Webserver (<span class="keyword">in</span> other terminal tab)
DEBUG=todoApp .<span class="regexp"><span class="delimiter">/</span><span class="content">bin</span><span class="delimiter">/</span></span>www
<span class="error">#</span> Test API (<span class="keyword">in</span> other terminal tab)
curl localhost:<span class="integer">3000</span>/todos
<span class="error">#</span> =&gt; []% 
</pre></td>
</tr></table>
 </figure></notextile></div>

<p><a href="https://github.com/amejiarosario/todoAPIjs/commit/54ab912ea9aa2b6633ae12816beb6e6c3d2702e6">变更</a></p>

<p>如果看到返回空数组[]则证明一切都准备就绪了。如果你看到错误，尝试回顾并确认没有遗漏每个步骤，或者在本贴子下面添加评论以寻求帮助。  </p>

<p><strong>创建： POST/ todos</strong><br />
回到<code>routes/todos.js</code>，我们将使用mongoose create[link]来实现用于创建的API。你能够在不参照下面例子的情况下尝试实现它吗？  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>routes/todos.js (showing just create route) </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
</pre></td>
  <td class="code"><pre>
<span class="comment">/* POST /todos */</span>
router.post(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(req, res, next) {
  Todo.create(req.body, <span class="keyword">function</span> (err, post) {
    <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);
    res.json(post);
  });
});
</pre></td>
</tr></table>
 </figure></notextile></div>

<p><a href="https://github.com/amejiarosario/todoAPIjs/commit/28b60c4bf9c6d8b08c3351f725e17c7f40a077be">变更</a>  </p>

<p>几点需要注意：  </p>

<ul>
  <li>这里我们使用<code>router.post</code>而不是<code>router.get</code>。  </li>
  <li>你必须关掉并且重启服务：<code>DEBUG=todoApp ./bin/www</code>。强烈推荐使用<code>nodemon</code>以自动刷新。执行<code>npm install nodemon</code>，然后通过<code>nodemon</code>运行程序。  </li>
</ul>

<p><strong>展示单条任务： GET /todos/:id</strong><br />
以下是一个使用<code>Todo.findeById</code>和<code>req.params</code>的快照。请注意<code>params</code>与路径中占位符名称相匹配。这里我们用的是<code>:id</code>。  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>routes/todos.js (showing just show route) </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
</pre></td>
  <td class="code"><pre>
<span class="comment">/* GET /todos/id */</span>
router.get(<span class="string"><span class="delimiter">'</span><span class="content">/:id</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(req, res, next) {
  Todo.findById(req.params.id, <span class="keyword">function</span> (err, post) {
    <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);
    res.json(post);
  });
});
</pre></td>
</tr></table>
 </figure></notextile></div>

<p><a href="https://github.com/amejiarosario/todoAPIjs/commit/7d8bc67178a4f162858395845c076d9223926bf8">变更</a></p>

<p>通过<em>POSTMAN</em>，使用一个你已经创建的元素<code>_id</code>来进行测试。例如：<code>localhost:3000/todos/542d7d290a705126360ac635</code>。  </p>

<p><strong>更新： PUT /todos/:id</strong><br />
回到<code>routes/todos.js</code>，我们来实现用于更新任务的API。请回顾findByIdAndUpdate[link]方法，并尝试利用它来实现该API。  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>routes/todos.js (showing just update route) </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
</pre></td>
  <td class="code"><pre>
<span class="comment">/* PUT /todos/:id */</span>
router.put(<span class="string"><span class="delimiter">'</span><span class="content">/:id</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(req, res, next) {
  Todo.findByIdAndUpdate(req.params.id, req.body, <span class="keyword">function</span> (err, post) {
    <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);
    res.json(post);
  });
});
</pre></td>
</tr></table>
 </figure></notextile></div>

<p><a href="https://github.com/amejiarosario/todoAPIjs/commit/00dafe491e0d0b59fa53e86d8c187c42d7824200">变更</a></p>

<p>同样请在<em>POSTMAN</em>中测试 :-)  </p>

<p><strong>删除： DELETE /todos/:id</strong><br />
终于轮到最后一个API了！几乎与<code>update</code>完全相同，使用<code>findByIdAndRemove</code>。  </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header"><span>routes/todos.js (showing just update route) </span></figcaption>
 <table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
<a href="#n8" name="n8">8</a>
</pre></td>
  <td class="code"><pre>
<span class="comment">/* DELETE /todos/:id */</span>
router.<span class="keyword">delete</span>(<span class="string"><span class="delimiter">'</span><span class="content">/:id</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(req, res, next) {
  Todo.findByIdAndRemove(req.params.id, req.body, <span class="keyword">function</span> (err, post) {
    <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);
    res.json(post);
  });
});
</pre></td>
</tr></table>
 </figure></notextile></div>

<p><a href="https://github.com/amejiarosario/todoAPIjs/commit/cbf5366e2b4e1a683ed50d2148ed6a548616d3f8">变更</a>  </p>

<p>上面的API都正常工作吗？非常好，你已经完成了我们教程的第二部分。如果有错误，请参照<a href="https://github.com/amejiarosario/todoAPIjs">完整代码</a>。  </p>

<h2 id="section-2">下一步？</h2>
<p>将AngularJS与后台服务连接。  </p>

<ul>
  <li>第三部分 - <a href="http://gocwind.com/blog/2015/06/09/mean-stack-tutorial-mongodb-expressjs-angularjs-nodejs/">MEAN全栈开发：前后端整合</a>    </li>
</ul>

<p><img src="http://dl.iteye.com/upload/picture/pic/133685/7c4ef50f-b7cd-3334-a29e-816cfcea7eba.png" />  </p>

<p><strong>相关教程：</strong>  </p>

<ul>
  <li>第一部分 - <a href="http://gocwind.com/blog/2015/06/05/angularjs-tutorial-for-beginners/">MEAN全栈开发：AngularJS实战教程</a>  </li>
  <li>第三部分 - <a href="http://gocwind.com/blog/2015/06/09/mean-stack-tutorial-mongodb-expressjs-angularjs-nodejs/">MEAN全栈开发：前后端整合</a>  </li>
  <li><a href="http://adrianmejia.com/blog/categories/backbonejs">BackboneJS教程</a>    </li>
</ul>

<p>原文链接：<a href="http://adrianmejia.com/blog/2014/10/01/creating-a-restful-api-tutorial-with-nodejs-and-mongodb/">Creating RESTful APIs With NodeJS and MongoDB Tutorial (Part II)</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">辰风君</span></span>

      



<time class='updated' datetime='2015-06-09T21:36:10+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:36 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/angularjs/'>AngularJS</a>, <a class='category' href='/blog/categories/expressjs/'>ExpressJS</a>, <a class='category' href='/blog/categories/mean/'>MEAN</a>, <a class='category' href='/blog/categories/mongodb/'>MongoDB</a>, <a class='category' href='/blog/categories/nodejs/'>NodeJS</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/blog/2015/06/05/angularjs-tutorial-for-beginners/" title="Previous Post: MEAN全栈开发：AngularJS实战教程">&laquo; MEAN全栈开发：AngularJS实战教程</a>
      
      
        <a class="basic-alignment right articlenav" href="/blog/2015/06/09/mean-stack-tutorial-mongodb-expressjs-angularjs-nodejs/" title="Next Post: MEAN全栈开发：前后端整合">MEAN全栈开发：前后端整合 &raquo;</a>
      
    </p>
  </footer>
</article>


  <section>
    <h1>Comments</h1>
    <div id="comments" aria-live="polite"><!-- Duoshuo Comment BEGIN -->
<div class="ds-thread" data-thread-key="/blog/2015/06/09/creating-a-restful-api-tutorial-with-nodejs-and-mongodb" data-title="MEAN全栈开发：使用NodeJS和MongoDB创建REST服务" data-url="http://cwind001.github.io/blog/2015/06/09/creating-a-restful-api-tutorial-with-nodejs-and-mongodb/"></div>
<script type="text/javascript">
  var duoshuoQuery = {short_name:"cwind"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>
<!-- Duoshuo Comment END -->
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>分类</h1>
    <ul id="category-list"><li><a href='/blog/categories/angularjs/'>AngularJS (3)</a></li><li><a href='/blog/categories/ehcache/'>Ehcache (1)</a></li><li><a href='/blog/categories/ejb/'>EJB (1)</a></li><li><a href='/blog/categories/expressjs/'>ExpressJS (3)</a></li><li><a href='/blog/categories/java/'>Java (6)</a></li><li><a href='/blog/categories/mean/'>MEAN (3)</a></li><li><a href='/blog/categories/mongodb/'>MongoDB (3)</a></li><li><a href='/blog/categories/nodejs/'>NodeJS (3)</a></li><li><a href='/blog/categories/spring/'>Spring (1)</a></li></ul>
</section>
<section>
  <h1>近期文章</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/06/09/mean-stack-tutorial-mongodb-expressjs-angularjs-nodejs/">MEAN全栈开发：前后端整合</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/09/creating-a-restful-api-tutorial-with-nodejs-and-mongodb/">MEAN全栈开发：使用NodeJS和MongoDB创建REST服务</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/05/angularjs-tutorial-for-beginners/">MEAN全栈开发：AngularJS实战教程</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/11/lightweight-framework-vs-heavyweight-framework/">轻量级框架与重量级框架</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/08/in-processes-vs-distributed-caching/">进程内缓存与分布式缓存的比较</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>标签云</h1>
    <span id="tag-cloud"><a href='/blog/categories/angularjs' style='font-size: 130.0%'>AngularJS(3)</a> <a href='/blog/categories/ehcache' style='font-size: 110.0%'>Ehcache(1)</a> <a href='/blog/categories/ejb' style='font-size: 110.0%'>EJB(1)</a> <a href='/blog/categories/expressjs' style='font-size: 130.0%'>ExpressJS(3)</a> <a href='/blog/categories/java' style='font-size: 160.0%'>Java(6)</a> <a href='/blog/categories/mean' style='font-size: 130.0%'>MEAN(3)</a> <a href='/blog/categories/mongodb' style='font-size: 130.0%'>MongoDB(3)</a> <a href='/blog/categories/nodejs' style='font-size: 130.0%'>NodeJS(3)</a> <a href='/blog/categories/spring' style='font-size: 110.0%'>Spring(1)</a> </span>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - 辰风君 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254461506'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1254461506%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

</footer>
  











</body>
</html>
